<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alchemical Ascension</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
      :root {
        --stone-950: #0c0a09;
        --stone-900: #1c1917;
        --stone-800: #292524;
        --stone-700: #44403c;
        --stone-500: #78716c;
        --stone-400: #a8a29e;
        --stone-200: #e7e5e4;
        
        --sky-300: #7dd3fc;
        --sky-400: #38bdf8;

        --amber-300: #fcd34d;
        --amber-400: #fbbf24;
        
        --violet-300: #c4b5fd;
        --violet-400: #a78bfa;

        --rose-400: #fb7185;
        --rose-500: #f43f5e;
        --rose-800: #9f1239;
        
        --emerald-500: #10b981;
        --teal-300: #5eead4;
        --teal-400: #2dd4bf;

        --font-sans: 'Lora', serif;
        --font-display: 'Cinzel', var(--font-sans);
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      html, body {
        height: 100%;
        overflow: hidden;
      }

      body {
        margin: 0;
        font-family: var(--font-sans);
        background-color: var(--stone-950);
        color: var(--stone-200);
        line-height: 1.5;
        background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%231c1917" fill-opacity="0.4"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
      }

      #root {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      
      .font-cinzel {
        font-family: var(--font-display);
      }

      /* Animations */
      @keyframes spin-slow {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      @keyframes spin-slow-reverse {
          from { transform: rotate(360deg); }
          to { transform: rotate(0deg); }
      }
      @keyframes float-up {
        0% {
          opacity: 1;
          transform: translate(-50%, -50%) translateY(0);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -100%) translateY(-50px);
        }
      }
      @keyframes essence-pulse {
          0%, 100% {
              transform: translate(-50%, -50%) scale(1);
              opacity: 0.8;
          }
          50% {
              transform: translate(-50%, -50%) scale(1.1);
              opacity: 1;
          }
      }
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: .5;
        }
      }
      @keyframes golem-float {
        0% { transform: translateY(0px) rotate(-5deg); }
        50% { transform: translateY(-10px) rotate(5deg); }
        100% { transform: translateY(0px) rotate(-5deg); }
      }
      @keyframes collect-effect {
        from {
          transform: translate(-50%, -50%) scale(0);
          opacity: 1;
        }
        to {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0;
        }
      }
      @keyframes particles-float {
        0% { transform: translateY(0); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateY(-100vh); opacity: 0; }
      }
      @keyframes ripple-effect-anim {
        to {
          transform: translate(-50%, -50%) scale(4);
          opacity: 0;
        }
      }
      
      /* New Grand Distillation Animations */
      @keyframes distillation-fade-in-out {
        0% { opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { opacity: 0; }
      }
      @keyframes distillation-burst {
        0% { transform: scale(0.1); opacity: 0; }
        20% { opacity: 1; }
        100% { transform: scale(50); opacity: 0; }
      }
      @keyframes distillation-wave {
        0% { transform: scale(0); opacity: 1; }
        100% { transform: scale(3); opacity: 0; }
      }
      @keyframes distillation-flash-anim {
        0% { transform: scale(0); opacity: 1; }
        50% { opacity: 0.5; }
        100% { transform: scale(2); opacity: 0; }
      }

      /* Prestige Sequence Animations */
      @keyframes shake-subtle {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); }
        75% { transform: translateX(-5px); }
      }
      @keyframes ui-dissolve-out {
        to { transform: scale(0.8); opacity: 0; filter: blur(5px); }
      }
      @keyframes ui-reform-in {
        from { transform: scale(0.8); opacity: 0; filter: blur(5px); }
        to { transform: scale(1); opacity: 1; filter: blur(0); }
      }
      @keyframes flask-collapse-to-center {
        0% { transform: scale(1); filter: brightness(1); }
        100% { transform: scale(0); filter: brightness(50); }
      }
      @keyframes modal-fade-in {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
      }


      .animate-spin-slow { animation: spin-slow 20s linear infinite; }
      .animate-spin-slow-reverse { animation: spin-slow-reverse 30s linear infinite; }
      .animate-float-up { animation: float-up 2s ease-out forwards; }
      .animate-essence-pulse { animation: essence-pulse 2.5s ease-in-out infinite; }
      .animate-pulse { animation: pulse 3s cubic-bezier(0.4,0,0.6,1) infinite; }
      .animate-golem-float { animation: golem-float 10s ease-in-out infinite; }
      .animate-collect-effect { animation: collect-effect 0.5s ease-out forwards; }
      
      button {
        font-family: inherit;
        font-size: 100%;
        line-height: 1.15;
        margin: 0;
        padding: 0;
        background-color: transparent;
        border: none;
        color: inherit;
        cursor: pointer;
      }

      button:focus {
        outline: 1px dotted;
        outline: 5px auto -webkit-focus-ring-color;
      }

      button:disabled {
        cursor: not-allowed;
      }
      
      /* Thematic Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--stone-900);
      }
      ::-webkit-scrollbar-thumb {
        background-color: var(--stone-700);
        border-radius: 4px;
        border: 2px solid var(--stone-900);
      }
      ::-webkit-scrollbar-thumb:hover {
        background-color: var(--stone-500);
      }

    </style>
    <!-- Load React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Load Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script type="text/babel" data-presets="react,typescript">
const { useState, useEffect, useCallback, useMemo, useRef, StrictMode } = React;

// === FROM types.ts ===
const Currency = {
  PrimaMateria: 'Prima Materia',
  PhilosophersDew: "Philosopher's Dew",
  Alkahest: 'Alkahest',
};

const UpgradeType = {
  Click: 'Click',
  Passive: 'Passive',
  Utility: 'Utility',
  Distillation: 'Distillation',
};


// === FROM utils/format.ts ===
const formatNumber = (num) => {
    if (typeof num !== 'number' || isNaN(num)) {
        num = 0;
    }
    if (num < 1000) {
        return num.toFixed(1).replace(/\.0$/, '');
    }
    const si = [
        { value: 1, symbol: "" },
        { value: 1E3, symbol: "K" },
        { value: 1E6, symbol: "M" },
        { value: 1E9, symbol: "B" },
        { value: 1E12, symbol: "T" },
        { value: 1E15, symbol: "P" },
        { value: 1E18, symbol: "E" }
    ];
    const rx = /\.0+$|(\.[0-9]*[1-9])0+$/;
    let i;
    for (i = si.length - 1; i > 0; i--) {
        if (num >= si[i].value) {
            break;
        }
    }
    return (num / si[i].value).toFixed(2).replace(rx, "$1") + si[i].symbol;
};

const formatDuration = (seconds) => {
    if (seconds < 60) return `${Math.floor(seconds)} seconds`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours`;
    return `${Math.floor(seconds / 86400)} days`;
};

// === FROM components/icons.tsx ===
const PrimaMateriaIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-full h-full">
    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm3.41 7.41l-2.82 2.82c-.38-.38-.83-.69-1.33-.9l3.24-3.24c.3-.3.77-.3 1.06 0s.3.77 0 1.06zM12 20c-1.85 0-3.53-.71-4.79-1.85l1.06-1.06c.94.83 2.16 1.35 3.53 1.35s2.59-.52 3.53-1.35l1.06 1.06C15.53 19.29 13.85 20 12 20zm-2.82-4.24l-3.24-3.24c-.3-.3-.3-.77 0-1.06s.77-.3 1.06 0l2.82 2.82c-.21.5-.52.95-.9 1.33zm9.23-2.35c-.12-.34-.31-.65-.55-.92l-1.95 1.95c.23.27.42.58.55.92H20v-1h-1.59zM4 11.59c.13-.34.32-.65.55-.92l1.95 1.95c-.23.27-.42.58-.55.92H4v-1h1.59zM12 6c1.85 0 3.53.71 4.79 1.85l-1.06 1.06C14.8 8.08 13.58 7.56 12.2 7.56s-2.6.52-3.53 1.35L7.61 7.85C8.87 6.71 10.55 6 12 6z"/>
  </svg>
);

const PhilosophersDewIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-full h-full">
        <path d="M12 2C8.69 2 6 4.69 6 8c0 2.25 1.83 4.22 3 5.41V20c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-6.59c1.17-1.19 3-3.16 3-5.41 0-3.31-2.69-6-6-6zm-2 6c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2z"/>
    </svg>
);

const AlkahestIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-full h-full">
        <path d="M12 2c5.52 0 10 4.48 10 10s-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2zm0 2c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm0 3c2.76 0 5 2.24 5 5s-2.24 5-5 5-5-2.24-5-5 2.24-5 5-5z"/>
    </svg>
);

const GolemIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-full h-full">
    <path d="M7 2v2H3v16h18V4h-4V2h-4v2h-2V2H7zm-2 4h14v12H5V6zm4 2v2h2V8H9zm4 0v2h2V8h-2zm-4 4v2h2v-2H9zm4 0v2h2v-2h-2z"/>
  </svg>
);

const HomunculusIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-full h-full">
    <path d="M12 5.5c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zM12 13c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
  </svg>
);

const StatsIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-full h-full">
      <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
    </svg>
);

// === FROM hooks/useGameLoop.ts ===
const useGameLoop = (callback, interval) => {
  const savedCallback = useRef(callback);

  useEffect(() => {
    savedCallback.current = callback;
  }, [callback]);

  useEffect(() => {
    const tick = () => {
      savedCallback.current();
    };
    if (interval !== null) {
      const id = setInterval(tick, interval);
      return () => clearInterval(id);
    }
  }, [interval]);
};

// === FROM components/UpgradeButton.tsx ===
const getCurrencyStyle = (currency) => {
  switch (currency) {
    case Currency.PrimaMateria:
      return { icon: <PrimaMateriaIcon />, color: 'var(--amber-400)' };
    case Currency.PhilosophersDew:
      return { icon: <PhilosophersDewIcon />, color: 'var(--violet-400)' };
    case Currency.Alkahest:
      return { icon: <AlkahestIcon />, color: 'var(--rose-400)' };
    default:
      return { icon: null, color: 'inherit' };
  }
};

const UpgradeButton = ({ upgrade, onPurchase, canAfford }) => {
  const isMaxLevel = upgrade.maxLevel && upgrade.level >= upgrade.maxLevel;
  const { icon, color } = getCurrencyStyle(upgrade.currency);

  return (
    <button
      onClick={() => onPurchase(upgrade.id)}
      disabled={!canAfford || isMaxLevel}
      className="upgrade-button"
    >
      <style>{`
        .upgrade-button {
          width: 100%;
          text-align: left;
          padding: 0.75rem;
          background-color: rgba(12, 10, 9, 0.5);
          border-radius: 0.5rem;
          border: 1px solid var(--stone-700);
          transition: all 200ms;
          position: relative;
          overflow: hidden;
        }
        .upgrade-button::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(120deg, transparent, rgba(125, 211, 252, 0.1), transparent);
          transition: left 400ms;
        }
        .upgrade-button:hover:not(:disabled)::before {
          left: 100%;
        }
        .upgrade-button:hover:not(:disabled) {
          background-color: rgba(41, 37, 36, 0.7);
          border-color: var(--sky-400);
        }
        .upgrade-button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }
        .upgrade-button:active:not(:disabled) {
          transform: scale(0.98);
          box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
      `}</style>
      <div style={{pointerEvents: 'none'}}>
        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
          <h4 className="font-cinzel" style={{fontWeight: 'bold'}}>{upgrade.name}</h4>
          <span style={{
            fontSize: '0.875rem',
            fontWeight: 600,
            padding: '0.25rem 0.5rem',
            borderRadius: '0.25rem',
            backgroundColor: isMaxLevel ? 'var(--emerald-500)' : 'var(--stone-700)',
            color: isMaxLevel ? 'white' : 'inherit'
          }}>
              {isMaxLevel ? 'MAX' : `Lvl ${upgrade.level}`}
          </span>
        </div>
        <p style={{fontSize: '0.875rem', fontStyle: 'italic', color: 'var(--stone-400)', marginTop: '0.25rem'}}>{upgrade.description}</p>
        <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', marginTop: '0.5rem', fontWeight: 600, color}}>
          {!isMaxLevel && (
              <>
                  <div style={{width: '1rem', height: '1rem'}}>{icon}</div>
                  <span>{formatNumber(upgrade.cost)}</span>
              </>
          )}
        </div>
      </div>
    </button>
  );
};


// === FROM components/UpgradesPanel.tsx ===
const TabButton = ({ tab, activeTab, onClick, icon }) => (
    <button
      onClick={() => onClick(tab)}
      className="tab-button"
      data-active={activeTab === tab}
      aria-pressed={activeTab === tab}
    >
      <style>{`
        .tab-button {
          display: flex;
          flex: 1 1 0%;
          align-items: center;
          justify-content: center;
          gap: 0.5rem;
          padding: 0.75rem;
          font-size: 0.875rem;
          font-weight: bold;
          border-bottom: 2px solid;
          transition: color 200ms, border-color 200ms;
          border-color: transparent;
          color: var(--stone-400);
        }
        .tab-button:hover {
          color: var(--sky-300);
        }
        .tab-button[data-active="true"] {
          border-color: var(--sky-400);
          color: var(--sky-400);
        }
      `}</style>
        <div style={{width: '1.25rem', height: '1.25rem', pointerEvents: 'none'}}>{icon}</div>
        <span style={{pointerEvents: 'none'}}>{tab}</span>
    </button>
);

const StatDisplay = ({ label, value }) => (
    <div style={{backgroundColor: 'rgba(12, 10, 9, 0.5)', padding: '0.75rem', borderRadius: '0.5rem', display: 'flex', justifyContent: 'space-between', alignItems: 'baseline'}}>
        <dt style={{fontSize: '0.875rem', color: 'var(--stone-400)'}}>{label}</dt>
        <dd className="font-cinzel" style={{fontWeight: 'bold', color: 'var(--sky-300)'}}>{value}</dd>
    </div>
);

const StatsPanel = ({ primaMateriaHistory, philosophersDewHistory, stats, onReset }) => {
    const primaMateriaPoints = primaMateriaHistory.map(d => d.total);
    const primaMateriaMaxY = Math.max(...primaMateriaPoints, 1);
    const primaMateriaMinY = primaMateriaHistory.length > 0 ? Math.min(...primaMateriaPoints) : 0;
    const primaMateriaRange = primaMateriaMaxY - primaMateriaMinY;
    
    const getPrimaMateriaPathData = () => {
        if (primaMateriaRange <= 0) return 'M 0,50 L 300,50';
        return primaMateriaPoints.map((p, i) => {
            const x = (i / (primaMateriaPoints.length - 1)) * 300;
            const y = 100 - ((p - primaMateriaMinY) / primaMateriaRange) * 100;
            return `${x},${y}`;
        }).join(' L ');
    };
    const primaMateriaPathData = primaMateriaHistory.length < 2 ? 'M 0,50 L 300,50' : getPrimaMateriaPathData();

    const dewPoints = philosophersDewHistory.map(d => d.total);
    const dewMaxY = Math.max(...dewPoints, 1);
    const dewMinY = philosophersDewHistory.length > 0 ? Math.min(...dewPoints) : 0;
    const dewRange = dewMaxY - dewMinY;

    const getDewPathData = () => {
        if (dewRange <= 0) return 'M 0,50 L 300,50';
        return dewPoints.map((p, i) => {
            const x = (i / (dewPoints.length - 1)) * 300;
            const y = 100 - ((p - dewMinY) / dewRange) * 100;
            return `${x},${y}`;
        }).join(' L ');
    };
    const dewPathData = philosophersDewHistory.length < 2 ? 'M 0,50 L 300,50' : getDewPathData();


    return (
        <div style={{padding: '1rem', display: 'flex', flexDirection: 'column', gap: '1rem'}}>
            <div>
                <h3 className="font-cinzel" style={{fontSize: '1.125rem', marginBottom: '0.5rem', textAlign: 'center', color: 'var(--amber-400)'}}>Prima Materia Total</h3>
                {primaMateriaHistory.length < 2 ? (
                    <div style={{textAlign: 'center', padding: '1rem', color: 'var(--stone-400)'}}>Gathering data...</div>
                ) : (
                    <div style={{position: 'relative', height: '6rem'}}>
                        <svg viewBox={`0 0 300 100`} style={{width: '100%', height: '100%'}} preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="primaMateriaAreaGradient" x1="0" x2="0" y1="0" y2="1">
                                    <stop offset="0%" stopColor="var(--amber-400)" stopOpacity="0.4"/>
                                    <stop offset="100%" stopColor="var(--amber-400)" stopOpacity="0"/>
                                </linearGradient>
                            </defs>
                            <path d={'M ' + primaMateriaPathData} fill="none" stroke="var(--amber-400)" strokeWidth="2" />
                            <path d={`M ${primaMateriaPathData.split(' ')[0]} L ${primaMateriaPathData} L 300,100 L 0,100 Z`} fill="url(#primaMateriaAreaGradient)" />
                        </svg>
                        <div style={{position: 'absolute', top: 0, left: 0, fontSize: '0.75rem', color: 'var(--stone-400)'}}>{formatNumber(primaMateriaMaxY)}</div>
                        <div style={{position: 'absolute', bottom: 0, left: 0, fontSize: '0.75rem', color: 'var(--stone-400)'}}>{formatNumber(primaMateriaMinY)}</div>
                    </div>
                )}
            </div>

            <div>
                <h3 className="font-cinzel" style={{fontSize: '1.125rem', marginBottom: '0.5rem', textAlign: 'center', color: 'var(--violet-400)'}}>Philosopher's Dew Total</h3>
                {philosophersDewHistory.length < 2 ? (
                    <div style={{textAlign: 'center', padding: '1rem', color: 'var(--stone-400)'}}>Gathering data...</div>
                ) : (
                    <div style={{position: 'relative', height: '6rem'}}>
                        <svg viewBox={`0 0 300 100`} style={{width: '100%', height: '100%'}} preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="dewAreaGradient" x1="0" x2="0" y1="0" y2="1">
                                    <stop offset="0%" stopColor="var(--violet-400)" stopOpacity="0.4"/>
                                    <stop offset="100%" stopColor="var(--violet-400)" stopOpacity="0"/>
                                </linearGradient>
                            </defs>
                            <path d={'M ' + dewPathData} fill="none" stroke="var(--violet-400)" strokeWidth="2" />
                            <path d={`M ${dewPathData.split(' ')[0]} L ${dewPathData} L 300,100 L 0,100 Z`} fill="url(#dewAreaGradient)" />
                        </svg>
                        <div style={{position: 'absolute', top: 0, left: 0, fontSize: '0.75rem', color: 'var(--stone-400)'}}>{formatNumber(dewMaxY)}</div>
                        <div style={{position: 'absolute', bottom: 0, left: 0, fontSize: '0.75rem', color: 'var(--stone-400)'}}>{formatNumber(dewMinY)}</div>
                    </div>
                )}
            </div>

            <dl style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                <StatDisplay label="Materia/sec" value={formatNumber(stats.primaMateriaPerSecond)} />
                <StatDisplay label="Dew/sec" value={formatNumber(stats.philosophersDewPerSecond)} />
                <StatDisplay label="Materia/click" value={formatNumber(stats.primaMateriaPerClick)} />
                <StatDisplay label="Distillation Bonus" value={stats.distillationBonus} />
                <StatDisplay label="Total Clicks" value={formatNumber(stats.totalClicks)} />
                <StatDisplay label="Materia (this Distillate)" value={stats.totalPrimaMateriaEver} />
                <StatDisplay label="Dew (this Distillate)" value={stats.totalPhilosophersDewEver} />
                <StatDisplay label="Essences Collected" value={stats.essencesClicked} />
                <StatDisplay label="Golems Harvested" value={stats.golemsMined} />
                <StatDisplay label="Distillations" value={stats.distillationCount} />
                <StatDisplay label="Play Time" value={stats.playTime} />
            </dl>
            <div style={{paddingTop: '1rem', marginTop: '1rem', borderTop: '1px solid var(--stone-700)'}}>
              <button
                onClick={onReset}
                className="button-reset"
              >
                <style>{`
                  .button-reset {
                    width: 100%;
                    background-color: var(--stone-600);
                    color: white;
                    font-weight: bold;
                    padding: 0.5rem 1rem;
                    border-radius: 0.5rem;
                    transition: background-color 200ms;
                  }
                  .button-reset:hover {
                    background-color: var(--stone-500);
                  }
                `}</style>
                Reset Save Data
              </button>
            </div>
        </div>
    );
};

const UpgradesPanel = ({ upgrades, onPurchase, currencies, onPrestige, canPrestige, prestigeCost, primaMateriaHistory, philosophersDewHistory, detailedStats, onResetSave }) => {
  const [activeTab, setActiveTab] = useState(Currency.PrimaMateria);

  const isUpgradeUnlocked = (upgrade) => {
    if (!upgrade.requirement) return true;
    const requiredUpgrade = upgrades[upgrade.requirement.upgradeId];
    return requiredUpgrade && requiredUpgrade.level >= upgrade.requirement.level;
  };
  
  const filteredUpgrades = Object.values(upgrades)
    .filter((u) => u.currency === activeTab && isUpgradeUnlocked(u));

  return (
    <div style={{backgroundColor: 'rgba(28, 25, 23, 0.6)', backdropFilter: 'blur(8px)', borderRadius: '0.5rem', border: '1px solid var(--stone-700)', height: '100%', display: 'flex', flexDirection: 'column'}}>
      <div style={{display: 'flex', borderBottom: '1px solid var(--stone-700)', flexShrink: 0}}>
        <TabButton tab={Currency.PrimaMateria} activeTab={activeTab} onClick={setActiveTab} icon={<PrimaMateriaIcon />} />
        <TabButton tab={Currency.PhilosophersDew} activeTab={activeTab} onClick={setActiveTab} icon={<PhilosophersDewIcon />} />
        <TabButton tab={Currency.Alkahest} activeTab={activeTab} onClick={setActiveTab} icon={<AlkahestIcon />} />
        <TabButton tab={'Stats'} activeTab={activeTab} onClick={setActiveTab} icon={<StatsIcon />} />
      </div>

      <div style={{flex: 1, overflowY: 'auto', minHeight: 0}}>
        {activeTab !== Currency.Alkahest && activeTab !== 'Stats' && (
          <div style={{padding: '1rem', display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
            {filteredUpgrades.map((upgrade) => (
              <UpgradeButton key={upgrade.id} upgrade={upgrade} onPurchase={onPurchase} canAfford={currencies[upgrade.currency] >= upgrade.cost}/>
            ))}
          </div>
        )}

        {activeTab === 'Stats' && <StatsPanel primaMateriaHistory={primaMateriaHistory} philosophersDewHistory={philosophersDewHistory} stats={detailedStats} onReset={onResetSave} />}

        {activeTab === Currency.Alkahest && (
            <div style={{padding: '1rem', display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                <div style={{backgroundColor: 'rgba(12, 10, 9, 0.5)', padding: '1rem', borderRadius: '0.5rem', textAlign: 'center', border: '1px solid var(--rose-800)'}}>
                    <h3 className="font-cinzel" style={{fontSize: '1.125rem', color: 'var(--rose-400)'}}>GRAND DISTILLATION</h3>
                    <p style={{fontSize: '0.875rem', color: 'var(--stone-400)', marginTop: '0.5rem'}}>Reset your progress to gain Alkahest and unlock powerful permanent enhancements.</p>
                    <p style={{fontSize: '0.75rem', color: 'var(--stone-500)', marginTop: '0.5rem'}}>Cost: {formatNumber(prestigeCost)} Prima Materia.</p>
                    <button 
                        onClick={onPrestige}
                        disabled={!canPrestige}
                        className="distillation-button"
                    >
                      <style>{`
                        .distillation-button {
                          margin-top: 1rem;
                          width: 100%;
                          background-color: var(--rose-500);
                          color: white;
                          font-weight: bold;
                          padding: 0.5rem 1rem;
                          border-radius: 0.5rem;
                          transition: all 200ms;
                          box-shadow: 0 10px 15px -3px rgba(244, 63, 94, 0.2), 0 4px 6px -2px rgba(244, 63, 94, 0.2);
                        }
                        .distillation-button:hover:not(:disabled) {
                          background-color: #f65f77;
                          transform: translateY(-2px);
                          box-shadow: 0 15px 20px -5px rgba(244, 63, 94, 0.3), 0 6px 8px -3px rgba(244, 63, 94, 0.3);
                        }
                        .distillation-button:active:not(:disabled) {
                          transform: translateY(0px);
                          box-shadow: 0 10px 15px -3px rgba(244, 63, 94, 0.2), 0 4px 6px -2px rgba(244, 63, 94, 0.2);
                        }
                        .distillation-button:disabled {
                          background-color: var(--rose-800);
                          color: var(--stone-400);
                          cursor: not-allowed;
                          box-shadow: none;
                        }
                      `}</style>
                        Begin the Great Work
                    </button>
                </div>
                {filteredUpgrades.map((upgrade) => (
                    <UpgradeButton key={upgrade.id} upgrade={upgrade} onPurchase={onPurchase} canAfford={currencies[upgrade.currency] >= upgrade.cost}/>
                ))}
            </div>
        )}
      </div>
    </div>
  );
};

// === FROM components/MainGameArea.tsx ===
const AnimatedParticles = () => {
  const particleCount = 20;
  return (
    <div className="particle-container">
       <style>{`
        .particle-container {
          position: absolute;
          inset: 0;
          overflow: hidden;
          pointer-events: none;
        }
        .particle {
          position: absolute;
          bottom: 0;
          background-color: var(--sky-300);
          border-radius: 50%;
          opacity: 0;
          animation: particles-float 10s infinite ease-in;
        }
      `}</style>
      {Array.from({ length: particleCount }).map((_, i) => (
        <div
          key={i}
          className="particle"
          style={{
            left: `${Math.random() * 100}%`,
            width: `${Math.random() * 3 + 1}px`,
            height: `${Math.random() * 3 + 1}px`,
            animationDelay: `${Math.random() * 10}s`,
            animationDuration: `${Math.random() * 10 + 5}s`,
            filter: `blur(${Math.random() > 0.5 ? 1 : 0}px)`
          }}
        />
      ))}
    </div>
  );
};

const MainGameArea = ({ onClick, floatingNumbers, alchemicalPower, floatingEssences, onEssenceClick, golems, onGolemClick, collectionEffects, homunculi, distillationPhase, lasers }) => {
  const [ripples, setRipples] = useState([]);
  const safePower = (typeof alchemicalPower === 'number' && isFinite(alchemicalPower)) ? alchemicalPower : 0;
  const hueShift = Math.min(safePower * 0.1, 120); 
  const coreColor = `hsl(${180 + hueShift}, 80%, 50%)`;

  const handleAtomClick = (e) => {
    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const newRipple = { id: Date.now(), x, y };
    setRipples(r => [...r, newRipple]);
    setTimeout(() => {
        setRipples(r => r.filter(rip => rip.id !== newRipple.id));
    }, 1000);

    onClick(e);
  };

  const atomStyle = {
    position: 'relative',
    width: '80%',
    height: '80%',
    transition: 'transform 100ms ease-in-out',
    filter: 'drop-shadow(0 10px 8px rgba(0,0,0,0.4))'
  };
  
  const essenceStyle = {
    position: 'absolute',
    width: '3rem',
    height: '3rem',
    borderRadius: '9999px',
    backgroundColor: 'rgba(251, 191, 36, 0.8)',
    backdropFilter: 'blur(4px)',
    border: '2px solid var(--amber-300)',
    boxShadow: '0 10px 15px -3px rgba(251, 191, 36, 0.3), 0 4px 6px -2px rgba(251, 191, 36, 0.3)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    color: 'black',
    fontWeight: 'bold',
    fontSize: '0.75rem',
    padding: '0.25rem',
    zIndex: 10,
  };

  const golemStyle = {
    position: 'absolute',
    width: '2.5rem',
    height: '2.5rem',
    color: 'var(--stone-400)',
    filter: 'drop-shadow(0 4px 3px rgba(0,0,0,0.5))',
    zIndex: 10,
    transition: 'opacity 0.2s'
  };

  const collectionEffectStyle = {
    position: 'absolute',
    width: '3rem',
    height: '3rem',
    borderRadius: '9999px',
    border: '2px solid var(--sky-300)',
    zIndex: 11,
    pointerEvents: 'none'
  };

  const homunculusStyle = {
    position: 'absolute',
    width: '1.5rem',
    height: '1.5rem',
    color: 'var(--sky-300)',
    filter: 'drop-shadow(0 0 5px var(--sky-300))',
    zIndex: 12,
    transition: 'left 0.1s linear, top 0.1s linear',
    pointerEvents: 'none',
  };

  return (
    <div style={{position: 'relative', width: '100%', maxWidth: '32rem', aspectRatio: '1/1', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
      <AnimatedParticles />
      {/* Lasers */}
      {lasers.map(laser => (
        <svg key={laser.id} style={{ position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', overflow: 'visible', pointerEvents: 'none', zIndex: 11 }}>
          <line
            x1={`${laser.from.x}%`}
            y1={`${laser.from.y}%`}
            x2={`${laser.to.x}%`}
            y2={`${laser.to.y}%`}
            stroke="#34d399"
            strokeWidth="2"
            strokeLinecap="round"
          >
             <animate attributeName="opacity" from="1" to="0" dur="0.2s" fill="freeze" />
          </line>
        </svg>
      ))}

      {/* Homunculi */}
      {homunculi.map(homunculus => (
        <div 
          key={homunculus.id}
          style={{
            ...homunculusStyle,
            left: `${homunculus.x}%`,
            top: `${homunculus.y}%`,
          }}
        >
          <HomunculusIcon />
        </div>
      ))}

      {/* Collection Effects */}
      {collectionEffects.map(effect => (
        <div 
          key={effect.id}
          className="animate-collect-effect"
          style={{
            ...collectionEffectStyle,
            left: `${effect.x}%`,
            top: `${effect.y}%`,
          }}
        />
      ))}

       {/* Floating Essences */}
       {floatingEssences.map(essence => (
        <button
          key={essence.id}
          onClick={() => onEssenceClick(essence.id)}
          className="animate-essence-pulse"
          style={{
            ...essenceStyle,
            left: `${essence.x}%`,
            top: `${essence.y}%`,
            transform: 'translate(-50%, -50%)',
          }}
          aria-label={`Click to collect ${formatNumber(essence.value)} Prima Materia`}
        >
          +{formatNumber(essence.value)}
        </button>
      ))}

      {/* Golems */}
      {golems.map(golem => {
          const damageOpacity = golem.health / golem.maxHealth;
          return (
            <button
              key={golem.id}
              onClick={() => onGolemClick(golem.id)}
              className="animate-golem-float"
              style={{
                ...golemStyle,
                left: `${golem.x}%`,
                top: `${golem.y}%`,
              }}
              aria-label={`Click to harvest Prima Materia`}
            >
              <div style={{ position: 'relative', width: '100%', height: '100%' }}>
                  <div style={{ position: 'absolute', inset: 0, opacity: 0.2, transition: 'opacity 0.2s' }}>
                      <GolemIcon />
                  </div>
                  <div style={{ position: 'absolute', inset: 0, opacity: damageOpacity, clipPath: `inset(${(1 - damageOpacity) * 100}% 0 0 0)` }}>
                      <GolemIcon />
                  </div>
              </div>
            </button>
          )
      })}

      <button
        onClick={handleAtomClick}
        className="active-scale-95 atom-button"
        aria-label="Click to generate Prima Materia"
        style={atomStyle}
      >
        <style>{`
            .atom-button {
                opacity: 1;
                transform: scale(1);
            }
            .atom-container {
                width: 100%; height: 100%; position: relative;
                display: flex; align-items: center; justify-content: center;
                transform: scale(0.75);
            }
            .nucleus {
                width: 25%; height: 25%;
                background-color: ${coreColor};
                border-radius: 50%;
                box-shadow: 0 0 20px 8px ${coreColor}, inset 0 0 10px rgba(255,255,255,0.5);
                animation: pulse 2s infinite ease-in-out;
                z-index: 1;
            }
            .orbit {
                position: absolute;
                width: 100%; height: 100%;
                border: 2px solid rgba(125, 211, 252, 0.3);
                border-radius: 50%;
            }
            .orbit--1 { animation: spin-slow 8s linear infinite; }
            .orbit--2 { transform: rotate(60deg); animation: spin-slow 10s linear infinite reverse; }
            .orbit--3 { transform: rotate(-60deg); animation: spin-slow 12s linear infinite; }
            .electron {
                position: absolute;
                width: 8%; height: 8%;
                background-color: var(--sky-300);
                border-radius: 50%;
                box-shadow: 0 0 10px var(--sky-300);
                top: -4%;
                left: 50%;
                transform: translateX(-50%);
            }
            [data-distillation-phase="collapsing"] .atom-button {
                animation: flask-collapse-to-center 1s 0.2s ease-in forwards;
            }
            [data-distillation-phase="exploding"] .atom-button,
            [data-distillation-phase="reforming"] .atom-button {
                opacity: 0;
            }
            .ripple-effect {
              position: absolute;
              border-radius: 50%;
              border: 2px solid var(--sky-300);
              pointer-events: none;
              transform: translate(-50%, -50%) scale(0);
              animation: ripple-effect-anim 1s ease-out;
            }
        `}</style>
        <div className="atom-container">
            <div className="nucleus"></div>
            <div className="orbit orbit--1"><div className="electron"></div></div>
            <div className="orbit orbit--2"><div className="electron"></div></div>
            <div className="orbit orbit--3"><div className="electron"></div></div>
        </div>
        
        {ripples.map(ripple => (
            <div key={ripple.id} className="ripple-effect" style={{ left: ripple.x, top: ripple.y, width: '50px', height: '50px' }} />
        ))}

        {/* Floating Numbers */}
        {floatingNumbers.map(num => (
          <div
            key={num.id}
            className="font-cinzel animate-float-up"
            style={{
                position: 'absolute',
                fontSize: '1.5rem',
                fontWeight: 'bold',
                color: num.isDew ? 'var(--violet-300)' : num.isCrit ? 'var(--rose-400)' : 'var(--amber-300)',
                textShadow: '0 0 5px black',
                pointerEvents: 'none',
                left: `${num.x}%`,
                top: `${num.y}%`,
                transform: 'translate(-50%, -50%)'
            }}
          >
            {num.value}
          </div>
        ))}
      </button>

      <style>{`
        .active-scale-95:active {
          transform: scale(0.95);
        }
      `}</style>
    </div>
  );
};

// === FROM components/Header.tsx ===
const CurrencyDisplay = ({ icon, amount, name, color }) => (
    <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem', backgroundColor: 'rgba(28, 25, 23, 0.6)', backdropFilter: 'blur(8px)', padding: '0.5rem 0.75rem', borderRadius: '0.5rem', border: '1px solid var(--stone-700)', color}}>
        <div style={{width: '2rem', height: '2rem', filter: `drop-shadow(0 0 4px ${color})`}}>{icon}</div>
        <div>
            <div className="font-cinzel" style={{fontSize: '1.125rem', lineHeight: 1}}>{formatNumber(amount)}</div>
            <div style={{fontSize: '0.75rem', color: 'var(--stone-400)'}}>{name}</div>
        </div>
    </div>
);


const Header = ({ currencies }) => {
  return (
    <header style={{display: 'flex', flexDirection: 'column', justifyContent: 'space-between', alignItems: 'center', gap: '1rem'}}>
      <style>{`
        @media (min-width: 1024px) {
          header {
            flex-direction: row;
            gap: 1rem;
          }
        }
      `}</style>
      <h1 className="font-cinzel" style={{fontSize: '1.875rem', fontWeight: 'bold', color: 'var(--sky-300)', textShadow: '0 0 8px rgba(125, 211, 252, 0.5)', textAlign: 'center'}}>
         <style>{`
            @media (min-width: 1024px) {
              h1 {
                font-size: 2.25rem;
              }
            }
        `}</style>
        Alchemical Ascension
      </h1>
      <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '0.75rem', width: '100%', maxWidth: '48rem'}}>
        <CurrencyDisplay
            icon={<PrimaMateriaIcon />}
            amount={currencies[Currency.PrimaMateria]}
            name="Prima Materia"
            color="var(--amber-300)"
        />
        <CurrencyDisplay
            icon={<PhilosophersDewIcon />}
            amount={currencies[Currency.PhilosophersDew]}
            name="Philosopher's Dew"
            color="var(--violet-300)"
        />
        <CurrencyDisplay
            icon={<AlkahestIcon />}
            amount={currencies[Currency.Alkahest]}
            name="Alkahest"
            color="var(--rose-400)"
        />
      </div>
    </header>
  );
};

// === FROM App.tsx ===
const LoadingScreen = ({ onLoaded }) => {
    const [phase, setPhase] = useState('loading');

    useEffect(() => {
        const timer1 = setTimeout(() => setPhase('fading'), 2500);
        const timer2 = setTimeout(() => {
            setPhase('finished');
            onLoaded();
        }, 3500);

        return () => {
            clearTimeout(timer1);
            clearTimeout(timer2);
        };
    }, [onLoaded]);

    if (phase === 'finished') return null;

    return (
        <div className="loading-overlay" data-phase={phase}>
            <style>{`
                .loading-overlay {
                    position: fixed;
                    inset: 0;
                    background-color: var(--stone-950);
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    transition: opacity 1s ease-in-out;
                    opacity: 1;
                }
                .loading-overlay[data-phase="fading"] {
                    opacity: 0;
                }
                .alchemical-symbol {
                    width: 150px;
                    height: 150px;
                    position: relative;
                }
                .alchemical-symbol svg {
                    position: absolute;
                    top: 0; left: 0; width: 100%; height: 100%;
                    stroke: var(--sky-300);
                    fill: none;
                    stroke-width: 2;
                    stroke-linecap: round;
                }
                .alchemical-symbol .circle-bg {
                    stroke: var(--stone-800);
                }
                .alchemical-symbol .circle-draw {
                    stroke-dasharray: 290;
                    stroke-dashoffset: 290;
                    animation: draw-circle 2s 0.5s ease-out forwards;
                }
                .alchemical-symbol .inner-symbols {
                    opacity: 0;
                    animation: fade-in-symbols 1s 1.5s ease-in forwards;
                }
                .alchemical-symbol .outer-ring {
                    animation: spin-slow 20s linear infinite;
                }
                 .alchemical-symbol .inner-ring {
                    transform-origin: center;
                    animation: spin-slow-reverse 15s linear infinite;
                }
                .loading-title {
                    font-family: var(--font-display);
                    font-size: 2rem;
                    color: var(--stone-200);
                    margin-top: 1.5rem;
                    opacity: 0;
                    animation: fade-in-symbols 1.5s 1s ease-in forwards;
                    text-shadow: 0 0 8px rgba(125, 211, 252, 0.5);
                }

                @keyframes draw-circle {
                    to { stroke-dashoffset: 0; }
                }
                @keyframes fade-in-symbols {
                    to { opacity: 1; }
                }
            `}</style>
            <div className="alchemical-symbol">
                 <svg viewBox="0 0 100 100" className="outer-ring">
                    <circle className="circle-bg" cx="50" cy="50" r="48"/>
                    <circle className="circle-draw" cx="50" cy="50" r="48" transform="rotate(-90 50 50)"/>
                </svg>
                <svg viewBox="0 0 100 100" className="inner-ring">
                    <path className="inner-symbols" d="M50 10 L65 35 L50 60 L35 35 Z" strokeWidth="1.5" />
                    <circle className="inner-symbols" cx="50" cy="50" r="20" strokeWidth="1.5" />
                </svg>
                 <svg viewBox="0 0 100 100">
                    <path className="inner-symbols" d="M50 15 L50 85 M15 50 L85 50" strokeWidth="1" />
                </svg>
            </div>
            <h1 className="loading-title">Alchemical Ascension</h1>
        </div>
    );
};

const ModalStyles = () => (
    <style>{`
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: var(--stone-800);
            border: 1px solid var(--stone-700);
            border-radius: 0.75rem;
            padding: 2rem;
            max-width: 28rem;
            width: 90%;
            text-align: center;
            animation: modal-fade-in 0.3s ease-out;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.4), 0 8px 10px -6px rgb(0 0 0 / 0.4);
        }
        .modal-content h2 {
            font-family: var(--font-display);
            color: var(--sky-300);
            font-size: 1.5rem;
            margin-top: 0;
        }
        .modal-content p {
            color: var(--stone-400);
            margin: 0.5rem 0 1.5rem;
        }
        .gains-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin: 1.5rem 0;
            text-align: left;
        }
        .gain-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--stone-900);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        .gain-item .icon { width: 1.5rem; height: 1.5rem; }
        .gain-item .amount { font-weight: bold; font-family: var(--font-display); }
        .gain-item .name { font-size: 0.875rem; }
        .modal-button {
            width: 100%;
            background-color: var(--sky-400);
            color: var(--stone-900);
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 200ms, transform 150ms;
        }
        .modal-button:hover {
            background-color: var(--sky-300);
            transform: translateY(-2px);
        }
    `}</style>
);

const OfflineReportModal = ({ report, onClose }) => (
    <div className="modal-overlay">
        <ModalStyles />
        <div className="modal-content">
            <h2>Welcome Back, Alchemist!</h2>
            <p>While you were away for {formatDuration(report.duration)}, your laboratory produced:</p>
            <div className="gains-grid">
                <div className="gain-item" style={{color: 'var(--amber-300)'}}>
                    <div className="icon"><PrimaMateriaIcon /></div>
                    <div>
                        <div className="amount">{formatNumber(report.primaMateria)}</div>
                        <div className="name">Prima Materia</div>
                    </div>
                </div>
                <div className="gain-item" style={{color: 'var(--violet-300)'}}>
                    <div className="icon"><PhilosophersDewIcon /></div>
                    <div>
                        <div className="amount">{formatNumber(report.philosophersDew)}</div>
                        <div className="name">Philosopher's Dew</div>
                    </div>
                </div>
                {report.essences > 0 && (
                    <div className="gain-item" style={{color: 'var(--amber-300)'}}>
                        <div className="icon" style={{opacity: 0.8}}><PrimaMateriaIcon /></div>
                        <div>
                            <div className="amount">{formatNumber(report.essences)}</div>
                            <div className="name">From Essences</div>
                        </div>
                    </div>
                )}
                {report.golems > 0 && (
                    <div className="gain-item" style={{color: 'var(--amber-300)'}}>
                        <div className="icon"><GolemIcon /></div>
                        <div>
                            <div className="amount">{formatNumber(report.golems)}</div>
                            <div className="name">From Golems</div>
                        </div>
                    </div>
                )}
            </div>
            <button onClick={onClose} className="modal-button">Continue</button>
        </div>
    </div>
);

const DistillationConfirmationModal = ({ onConfirm, onCancel, cost, gain }) => (
    <div className="modal-overlay">
        <ModalStyles />
        <style>{`
          .distill-summary {
            background-color: var(--stone-900);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1.5rem 0;
            text-align: left;
            border: 1px solid var(--stone-700);
          }
          .distill-summary > div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
          }
          .distill-summary > div:not(:last-child) {
            border-bottom: 1px solid var(--stone-700);
          }
          .distill-summary span { color: var(--stone-400); }
          .distill-summary .cost-value { font-weight: bold; color: var(--amber-300); font-family: var(--font-display); }
          .distill-summary .gain-value { font-weight: bold; color: var(--rose-400); font-family: var(--font-display); }
          .modal-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
          .modal-button-cancel {
            flex: 1; background-color: var(--stone-600); color: var(--stone-200); font-weight: bold; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 200ms, transform 150ms;
          }
          .modal-button-cancel:hover { background-color: var(--stone-500); transform: translateY(-2px); }
          .modal-button-confirm {
            flex: 2; background-color: var(--rose-500); color: white; font-weight: bold; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 200ms, transform 150ms;
          }
          .modal-button-confirm:hover { background-color: var(--rose-400); transform: translateY(-2px); }
        `}</style>
        <div className="modal-content">
            <h2 style={{color: 'var(--rose-400)'}}>The Grand Distillation</h2>
            <p>Your progress will be reset in exchange for Alkahest, granting immense power for future endeavors. This act is irreversible.</p>
            <div className="distill-summary">
              <div>
                <span>Cost</span>
                <span className="cost-value">{formatNumber(cost)} Prima Materia</span>
              </div>
              <div>
                <span>Gain</span>
                <span className="gain-value">+{formatNumber(gain)} Alkahest</span>
              </div>
            </div>
            <div className="modal-actions">
              <button onClick={onCancel} className="modal-button-cancel">Reconsider</button>
              <button onClick={onConfirm} className="modal-button-confirm">Begin the Great Work</button>
            </div>
        </div>
    </div>
);

const DistillationSummaryModal = ({ alkahestGained, onClose }) => (
    <div className="modal-overlay">
        <ModalStyles />
        <div className="modal-content">
            <h2>Distillation Complete</h2>
            <p>The cosmos has been reformed by your will. Through sacrifice, you have achieved a new level of understanding.</p>
            <div className="gains-grid" style={{gridTemplateColumns: '1fr'}}>
               <div className="gain-item" style={{color: 'var(--rose-400)', justifyContent: 'center'}}>
                    <div className="icon" style={{width: '2rem', height: '2rem'}}><AlkahestIcon /></div>
                    <div>
                        <div className="amount" style={{fontSize: '1.5rem'}}>+{formatNumber(alkahestGained)}</div>
                        <div className="name">Alkahest</div>
                    </div>
                </div>
            </div>
            <p style={{marginTop: '1.5rem'}}>Your journey begins anew, bolstered by ancient knowledge.</p>
            <button onClick={onClose} className="modal-button">Ascend Again</button>
        </div>
    </div>
);


const INITIAL_UPGRADES = {
  // --- Prima Materia Upgrades ---
  clickPower1: { id: 'clickPower1', name: 'Potent Stirring', description: 'Increases Prima Materia per click.', level: 1, baseCost: 5, cost: 5, costIncrease: 1.15, effect: level => level * 1, type: UpgradeType.Click, currency: Currency.PrimaMateria },
  bellows: { id: 'bellows', name: 'Automated Bellows', description: 'Passively generates Prima Materia. Bonus from total clicks.', level: 0, baseCost: 15, cost: 15, costIncrease: 1.18, effect: (level, state) => level * 0.5 * (1 + Math.log10(state.stats.totalClicks + 1) * 0.1), type: UpgradeType.Passive, currency: Currency.PrimaMateria },
  catalyticWand: { id: 'catalyticWand', name: 'Catalytic Wand', description: 'Grants a powerful bonus to click power.', level: 0, baseCost: 100, cost: 100, costIncrease: 1.2, effect: level => level * 5, type: UpgradeType.Click, currency: Currency.PrimaMateria, requirement: { upgradeId: 'clickPower1', level: 10 } },
  golemProspecting: { id: 'golemProspecting', name: 'Golem Prospecting', description: 'Your bellows sometimes unearth clickable Golems.', level: 0, baseCost: 2500, cost: 2500, costIncrease: 1.3, effect: level => level * 0.05, type: UpgradeType.Utility, currency: Currency.PrimaMateria, requirement: { upgradeId: 'bellows', level: 10 } },
  homunculusService: { id: 'homunculusService', name: 'Homunculus Service', description: 'Automatically harvest Golems. At Lvl 3, a Homunculus is dispatched for each Golem.', level: 0, baseCost: 75000, cost: 75000, costIncrease: 3, effect: level => level, type: UpgradeType.Utility, currency: Currency.PrimaMateria, maxLevel: 3, requirement: { upgradeId: 'golemProspecting', level: 1 } },
  focusingLens: { id: 'focusingLens', name: 'Focusing Lens', description: 'Atom electrons fire lasers at Golems, increasing your click reward.', level: 0, baseCost: 150000, cost: 150000, costIncrease: 1.5, effect: level => level * 5, type: UpgradeType.Utility, currency: Currency.PrimaMateria, requirement: { upgradeId: 'golemProspecting', level: 5 } },
  philosophersEngine: { id: 'philosophersEngine', name: "Philosopher's Engine", description: 'Huge passive Prima Materia generation, boosted by Dew/sec.', level: 0, baseCost: 1e7, cost: 1e7, costIncrease: 1.4, effect: (level, state) => level * 1500 * (1 + Math.log10(state.philosophersDewPerSecond + 1) * 0.05), type: UpgradeType.Passive, currency: Currency.PrimaMateria, requirement: { upgradeId: 'golemProspecting', level: 15 } },
  echoingStir: { id: 'echoingStir', name: 'Echoing Stir', description: 'Passively clicks the atom once per second.', level: 0, baseCost: 1e9, cost: 1e9, costIncrease: 3, effect: level => level, type: UpgradeType.Passive, currency: Currency.PrimaMateria, maxLevel: 10, requirement: { upgradeId: 'philosophersEngine', level: 5 } },

  // --- Philosopher's Dew Upgrades ---
  alembic: { id: 'alembic', name: 'Alembic Condenser', description: "Passively generates Philosopher's Dew.", level: 0, baseCost: 10000, cost: 10000, costIncrease: 1.25, effect: level => level * 0.2, type: UpgradeType.Passive, currency: Currency.PrimaMateria },
  essenceCollector: { id: 'essenceCollector', name: 'Essence Collector', description: 'Spawns clickable Prima Materia Essences around the atom.', level: 0, baseCost: 25, cost: 25, costIncrease: 1.5, effect: level => level * 0.05, type: UpgradeType.Utility, currency: Currency.PhilosophersDew, maxLevel: 100, requirement: { upgradeId: 'alembic', level: 1 } },
  moonWaterSiphon: { id: 'moonWaterSiphon', name: 'Moon Water Siphon', description: "A new powerful source of passive Philosopher's Dew.", level: 0, baseCost: 100, cost: 100, costIncrease: 1.3, effect: level => level * 1, type: UpgradeType.Passive, currency: Currency.PhilosophersDew, requirement: { upgradeId: 'alembic', level: 15 } },
  essenceHomunculi: { id: 'essenceHomunculi', name: 'Essence Homunculi', description: 'Automatically collect Essences. At Lvl 3, collection is instant.', level: 0, baseCost: 250, cost: 250, costIncrease: 3, effect: level => level, type: UpgradeType.Utility, currency: Currency.PhilosophersDew, maxLevel: 3, requirement: { upgradeId: 'essenceCollector', level: 1 } },
  aethericWells: { id: 'aethericWells', name: 'Aetheric Wells', description: 'Increases the value of clickable Essences.', level: 0, baseCost: 500, cost: 500, costIncrease: 2, effect: level => 1 + level * 0.25, type: UpgradeType.Utility, currency: Currency.PhilosophersDew, requirement: { upgradeId: 'essenceCollector', level: 10 } },
  alchemicalSynergy: { id: 'alchemicalSynergy', name: 'Alchemical Synergy', description: 'Passive Materia generation is boosted by 1% of your Dew/sec.', level: 0, baseCost: 750, cost: 750, costIncrease: 2.2, effect: (level, state) => 1 + level * 0.01 * (state.philosophersDewPerSecond || 0), type: UpgradeType.Utility, currency: Currency.PhilosophersDew, requirement: { upgradeId: 'moonWaterSiphon', level: 5 } },
  goldenTransmutation: { id: 'goldenTransmutation', name: 'Golden Transmutation', description: 'Each Golem has a chance to be a Golden Golem, worth 100x more.', level: 0, baseCost: 1500, cost: 1500, costIncrease: 2.5, effect: level => level * 0.005, type: UpgradeType.Utility, currency: Currency.PhilosophersDew, maxLevel: 10, requirement: { upgradeId: 'alchemicalSynergy', level: 3 } },
  igneousDew: { id: 'igneousDew', name: 'Igneous Dew', description: "Boosts click power based on your total Philosopher's Dew.", level: 0, baseCost: 5000, cost: 5000, costIncrease: 3, effect: (level, state) => 1 + level * Math.log10(state?.totalPhilosophersDewEver + 1) * 0.01, type: UpgradeType.Utility, currency: Currency.PhilosophersDew, requirement: { upgradeId: 'goldenTransmutation', level: 1 } },
  laserCritChance: { id: 'laserCritChance', name: 'Laser Criticals', description: 'Lasers have a chance to deal 10x damage to Golems.', level: 0, baseCost: 25000, cost: 25000, costIncrease: 1.8, effect: level => level * 0.01, type: UpgradeType.Utility, currency: Currency.PhilosophersDew, maxLevel: 25, requirement: { upgradeId: 'igneousDew', level: 1 } },
  temporalDistortion: { id: 'temporalDistortion', name: 'Temporal Distortion', description: 'Boosts all passive generation by a percentage of your total Alkahest.', level: 0, baseCost: 100000, cost: 100000, costIncrease: 2.5, effect: (level, state) => 1 + level * 0.001 * state.currencies[Currency.Alkahest], type: UpgradeType.Utility, currency: Currency.PhilosophersDew, requirement: { upgradeId: 'laserCritChance', level: 5 } },

  // --- Alkahest Upgrades ---
  ancientKnowledge: { id: 'ancientKnowledge', name: 'Ancient Knowledge', description: 'Reduces the cost of all non-Alkahest upgrades by 2% per level.', level: 0, baseCost: 10, cost: 10, costIncrease: 4, effect: level => 1 - level * 0.02, type: UpgradeType.Distillation, currency: Currency.Alkahest, maxLevel: 25 },
  primordialSoup: { id: 'primordialSoup', name: 'Primordial Soup', description: 'Start each Distillation with a base amount of Prima Materia.', level: 0, baseCost: 5, cost: 5, costIncrease: 2, effect: level => level * 1000, type: UpgradeType.Distillation, currency: Currency.Alkahest },
  celestialDew: { id: 'celestialDew', name: 'Celestial Dew', description: "Start each Distillation with a base amount of Philosopher's Dew.", level: 0, baseCost: 15, cost: 15, costIncrease: 2.5, effect: level => level * 100, type: UpgradeType.Distillation, currency: Currency.Alkahest, requirement: { upgradeId: 'primordialSoup', level: 1 } },
  magnumOpus: { id: 'magnumOpus', name: 'Magnum Opus', description: 'Increases passive generation of Materia and Dew by 15% per level.', level: 0, baseCost: 25, cost: 25, costIncrease: 3, effect: level => 1 + level * 0.15, type: UpgradeType.Distillation, currency: Currency.Alkahest },
  aevumWarp: { id: 'aevumWarp', name: 'Aevum Warp', description: 'Offline progress is calculated at 2% higher efficiency per level.', level: 0, baseCost: 50, cost: 50, costIncrease: 5, effect: level => 1 + level * 0.02, type: UpgradeType.Distillation, currency: Currency.Alkahest, maxLevel: 25, requirement: { upgradeId: 'magnumOpus', level: 3 } },
  quintessence: { id: 'quintessence', name: 'Quintessence', description: 'The passive bonus from Distillations is 1% more effective per level.', level: 0, baseCost: 100, cost: 100, costIncrease: 2, effect: level => level * 0.01, type: UpgradeType.Distillation, currency: Currency.Alkahest, requirement: { upgradeId: 'aevumWarp', level: 1 } },
  unlockMateriaUpgrades: { id: 'unlockMateriaUpgrades', name: 'Materia Blueprints', description: 'Keep Prima Materia upgrades after a Distillation.', level: 0, baseCost: 250, cost: 250, costIncrease: 10, effect: level => level, type: UpgradeType.Distillation, currency: Currency.Alkahest, maxLevel: 1, requirement: { upgradeId: 'quintessence', level: 5 } },
  unlockDewUpgrades: { id: 'unlockDewUpgrades', name: 'Dew Schematics', description: "Keep Philosopher's Dew upgrades after a Distillation.", level: 0, baseCost: 500, cost: 500, costIncrease: 10, effect: level => level, type: UpgradeType.Distillation, currency: Currency.Alkahest, maxLevel: 1, requirement: { upgradeId: 'unlockMateriaUpgrades', level: 1 } },
};

const SAVE_KEY = 'alchemicalAscensionSave';

const getInitialState = () => {
    const upgradesCopy = {};
    for (const key of Object.keys(INITIAL_UPGRADES)) {
        const upgrade = INITIAL_UPGRADES[key];
        upgradesCopy[key] = { ...upgrade, costAetherium: 0 };
    }

    return {
        currencies: {
          [Currency.PrimaMateria]: 0,
          [Currency.PhilosophersDew]: 0,
          [Currency.Alkahest]: 0,
        },
        upgrades: upgradesCopy,
        totalPrimaMateriaEver: 0,
        totalPhilosophersDewEver: 0,
        totalAlkahestEver: 0,
        stats: {
            totalClicks: 0,
            distillationCount: 0,
            playTime: 0,
            essencesClicked: 0,
            golemsMined: 0,
        },
        lastTick: Date.now(),
        alkahestRetrofitDone: false,
    };
};

const loadGameState = () => {
    try {
        const savedJson = localStorage.getItem(SAVE_KEY);
        if (!savedJson) return getInitialState();

        const savedState = JSON.parse(savedJson);
        const initialState = getInitialState();
        const currentUpgrades = initialState.upgrades;

        if (savedState.upgrades) {
            for (const id in currentUpgrades) {
                const saved = savedState.upgrades[id];
                const initial = INITIAL_UPGRADES[id];
                if (saved && initial) {
                    const savedLevel = saved.level;
                    if (typeof savedLevel === 'number' && isFinite(savedLevel) && savedLevel >= 0) {
                        currentUpgrades[id].level = savedLevel;
                        let newCost = Math.ceil(initial.baseCost * Math.pow(initial.costIncrease, savedLevel));
                        currentUpgrades[id].cost = isFinite(newCost) ? newCost : initial.cost;
                    } else {
                        currentUpgrades[id].level = initial.level;
                        currentUpgrades[id].cost = initial.cost;
                    }
                }
            }
        }
        
        const finalState = {
            ...initialState,
            currencies: savedState.currencies ?? initialState.currencies,
            totalPrimaMateriaEver: savedState.totalPrimaMateriaEver ?? initialState.totalPrimaMateriaEver,
            totalPhilosophersDewEver: savedState.totalPhilosophersDewEver ?? initialState.totalPhilosophersDewEver,
            totalAlkahestEver: savedState.totalAlkahestEver ?? initialState.totalAlkahestEver,
            stats: {
                ...initialState.stats,
                ...(savedState.stats ?? {}),
            },
            upgrades: currentUpgrades,
            lastTick: savedState.lastTick ?? Date.now(),
            alkahestRetrofitDone: savedState.alkahestRetrofitDone ?? false,
        };

        // Retroactive Alkahest calculation
        if (!finalState.alkahestRetrofitDone && finalState.stats.distillationCount > 0) {
            const S = finalState.stats.distillationCount;
            const expectedAlkahest = S + (S * (S - 1) / 2);
            if (finalState.currencies[Currency.Alkahest] < expectedAlkahest) {
                finalState.currencies[Currency.Alkahest] = expectedAlkahest;
            }
            finalState.alkahestRetrofitDone = true;
        }

        return finalState;
    } catch (error) {
        console.error("Failed to load or parse saved state, starting fresh.", error);
        localStorage.removeItem(SAVE_KEY);
        return getInitialState();
    }
};


const App = () => {
  const [isLoading, setIsLoading] = useState(true);
  const [gameState, setGameState] = useState(loadGameState);
  const [floatingNumbers, setFloatingNumbers] = useState([]);
  const [floatingEssences, setFloatingEssences] = useState([]);
  const [golems, setGolems] = useState([]);
  const [homunculi, setHomunculi] = useState([]);
  const [collectionEffects, setCollectionEffects] = useState([]);
  const [lasers, setLasers] = useState([]);
  const [primaMateriaPerSecond, setPrimaMateriaPerSecond] = useState(0);
  const [philosophersDewPerSecond, setPhilosophersDewPerSecond] = useState(0);
  const [distillationPhase, setDistillationPhase] = useState('idle');
  const [distillationSummary, setDistillationSummary] = useState(null);
  const [primaMateriaHistory, setPrimaMateriaHistory] = useState([]);
  const [philosophersDewHistory, setPhilosophersDewHistory] = useState([]);
  const [offlineReport, setOfflineReport] = useState(null);
  const lastHistoryUpdate = useRef(Date.now());
  const gameStateRef = useRef(gameState);

  useEffect(() => {
    gameStateRef.current = gameState;
  }, [gameState]);

  const getClickValue = useCallback((state) => {
    if (!state) state = gameStateRef.current;
    const { upgrades, stats, totalPhilosophersDewEver } = state;
    const distillationBoost = 1 + (stats.distillationCount * (0.25 + upgrades.quintessence.effect(upgrades.quintessence.level, state)));
    const igneousBoost = upgrades.igneousDew.effect(upgrades.igneousDew.level, state);
    const baseClick = upgrades.clickPower1.effect(upgrades.clickPower1.level, state) + upgrades.catalyticWand.effect(upgrades.catalyticWand.level, state);
    return baseClick * distillationBoost * igneousBoost;
  }, []);

  const prestigeCost = useMemo(() => 1e6 * Math.pow(3.5, gameState.stats.distillationCount), [gameState.stats.distillationCount]);
  const alkahestToGain = useMemo(() => 1 + gameState.stats.distillationCount, [gameState.stats.distillationCount]);

  // Pass a snapshot of the gameState to the calculation functions
  const calculateRates = useCallback((state) => {
    const { upgrades, stats } = state;

    const distillationBoost = 1 + (stats.distillationCount * (0.25 + upgrades.quintessence.effect(upgrades.quintessence.level)));
    const magnumOpusBoost = upgrades.magnumOpus.effect(upgrades.magnumOpus.level);
    const temporalDistortionBoost = upgrades.temporalDistortion.effect(upgrades.temporalDistortion.level, state);

    // Dew per second for use in other calculations
    const pdps = (upgrades.alembic.effect(upgrades.alembic.level, state) + upgrades.moonWaterSiphon.effect(upgrades.moonWaterSiphon.level, state)) 
        * magnumOpusBoost 
        * temporalDistortionBoost;

    // Materia per second
    const bellowsProduction = upgrades.bellows.effect(upgrades.bellows.level, state);
    const engineProduction = upgrades.philosophersEngine.effect(upgrades.philosophersEngine.level, { ...state, philosophersDewPerSecond: pdps });
    const autoClickProduction = upgrades.echoingStir.effect(upgrades.echoingStir.level, state) * getClickValue(state);
    const synergyBoost = upgrades.alchemicalSynergy.effect(upgrades.alchemicalSynergy.level, { ...state, philosophersDewPerSecond: pdps });

    const pmps = (bellowsProduction + engineProduction + autoClickProduction) 
        * distillationBoost 
        * magnumOpusBoost 
        * synergyBoost
        * temporalDistortionBoost;
    
    return { pmps, pdps };
  }, [getClickValue]);


  useEffect(() => {
    const handleOfflineGains = () => {
        const now = Date.now();
        const state = gameStateRef.current;
        const offlineTime = (now - state.lastTick) / 1000;

        if (offlineTime > 10) { // Only show for more than 10s offline
            const aevumWarpBoost = state.upgrades.aevumWarp.effect(state.upgrades.aevumWarp.level, state);
            const effectiveOfflineTime = offlineTime * aevumWarpBoost;

            const rates = calculateRates(state);
            
            let essenceGains = 0;
            let golemGains = 0;
            let essencesCollected = 0;
            let golemsHarvested = 0;

            if (state.upgrades.essenceHomunculi.level >= 3) {
                const essenceSpawnRate = state.upgrades.essenceCollector.effect(state.upgrades.essenceCollector.level, state);
                const essenceValue = (rates.pmps + getClickValue(state)) * (5 + state.upgrades.essenceCollector.level * 0.5) * state.upgrades.aethericWells.effect(state.upgrades.aethericWells.level, state);
                essencesCollected = Math.floor(essenceSpawnRate * effectiveOfflineTime);
                essenceGains = essencesCollected * essenceValue;
            }
            if (state.upgrades.homunculusService.level >= 3) {
                const golemSpawnRate = state.upgrades.golemProspecting.effect(state.upgrades.golemProspecting.level, state);
                const golemValue = (rates.pmps + getClickValue(state)) * (10 + state.upgrades.golemProspecting.level); // Base value without laser damage
                golemsHarvested = Math.floor(golemSpawnRate * effectiveOfflineTime);
                golemGains = golemsHarvested * golemValue;
            }
            
            const primaMateriaGained = rates.pmps * effectiveOfflineTime;
            const philosophersDewGained = rates.pdps * effectiveOfflineTime;
            const totalMateriaGained = primaMateriaGained + essenceGains + golemGains;

            if (totalMateriaGained > 0 || philosophersDewGained > 0) {
              setOfflineReport({
                  primaMateria: primaMateriaGained,
                  philosophersDew: philosophersDewGained,
                  essences: essenceGains,
                  golems: golemGains,
                  duration: offlineTime,
              });

              // Apply the gains directly to the state
              setGameState(prev => ({
                  ...prev,
                  currencies: {
                      ...prev.currencies,
                      [Currency.PrimaMateria]: prev.currencies[Currency.PrimaMateria] + totalMateriaGained,
                      [Currency.PhilosophersDew]: prev.currencies[Currency.PhilosophersDew] + philosophersDewGained,
                  },
                  totalPrimaMateriaEver: prev.totalPrimaMateriaEver + totalMateriaGained,
                  totalPhilosophersDewEver: prev.totalPhilosophersDewEver + philosophersDewGained,
                  stats: {
                      ...prev.stats,
                      playTime: prev.stats.playTime + offlineTime,
                      golemsMined: (prev.stats.golemsMined || 0) + golemsHarvested,
                      essencesClicked: (prev.stats.essencesClicked || 0) + essencesCollected,
                  },
                  lastTick: now, // IMPORTANT: Update lastTick to prevent gameLoop from re-applying gains
              }));
            }
        }
    };
    handleOfflineGains();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    const save = () => {
        try {
            const stateToSave = { ...gameStateRef.current, lastTick: Date.now() };
            localStorage.setItem(SAVE_KEY, JSON.stringify(stateToSave));
        } catch (error) {
            console.error("Failed to save game state:", error);
        }
    };

    const saveInterval = setInterval(save, 5000);
    window.addEventListener('beforeunload', save);

    return () => {
        clearInterval(saveInterval);
        window.removeEventListener('beforeunload', save);
    };
  }, []);

  const handleFlaskClick = useCallback((e) => {
    const clickValue = getClickValue(gameStateRef.current);
    
    const rect = e.currentTarget.getBoundingClientRect();
    const x = (e.clientX - rect.left) / rect.width * 100;
    const y = (e.clientY - rect.top) / rect.height * 100;

    setGameState(prev => ({
        ...prev,
        currencies: { 
          ...prev.currencies, 
          [Currency.PrimaMateria]: prev.currencies[Currency.PrimaMateria] + clickValue,
        },
        totalPrimaMateriaEver: prev.totalPrimaMateriaEver + clickValue,
        stats: { ...prev.stats, totalClicks: prev.stats.totalClicks + 1 },
    }));

    const newFloatingNumber = { id: Date.now() + Math.random(), value: `+${formatNumber(clickValue)}`, x, y };
    setFloatingNumbers(current => [...current, newFloatingNumber]);
    setTimeout(() => setFloatingNumbers(current => current.filter(n => n.id !== newFloatingNumber.id)), 2000);
  }, [getClickValue]);
  
  const handleEssenceClick = useCallback((essenceId) => {
    const essence = floatingEssences.find(o => o.id === essenceId);
    if (!essence) return;

    setGameState(prev => ({
      ...prev,
      currencies: { ...prev.currencies, [Currency.PrimaMateria]: prev.currencies[Currency.PrimaMateria] + essence.value },
      totalPrimaMateriaEver: prev.totalPrimaMateriaEver + essence.value,
      stats: { ...prev.stats, essencesClicked: (prev.stats.essencesClicked || 0) + 1 },
    }));
    
    setFloatingEssences(prev => prev.filter(o => o.id !== essenceId));
  }, [floatingEssences]);

  const handleGolemClick = useCallback((golemId) => {
    const golem = golems.find(a => a.id === golemId);
    if (!golem) return;

    const damageMultiplier = golem.maxHealth / golem.health;
    const value = golem.value * damageMultiplier;

    setGameState(prev => ({
      ...prev,
      currencies: { ...prev.currencies, [Currency.PrimaMateria]: prev.currencies[Currency.PrimaMateria] + value },
      totalPrimaMateriaEver: prev.totalPrimaMateriaEver + value,
      stats: { ...prev.stats, golemsMined: (prev.stats.golemsMined || 0) + 1 },
    }));
    
    setGolems(prev => prev.filter(a => a.id !== golemId));
  }, [golems]);

  const handlePurchaseUpgrade = useCallback((upgradeId) => {
    setGameState(prev => {
      const upgrade = prev.upgrades[upgradeId];
      if (upgrade.level >= (upgrade.maxLevel ?? Infinity)) return prev;

      let cost = upgrade.cost;
      
      if (upgrade.currency !== Currency.Alkahest) {
          cost *= prev.upgrades.ancientKnowledge.effect(prev.upgrades.ancientKnowledge.level, prev);
      }
      
      if (prev.currencies[upgrade.currency] < cost) return prev;

      const newLevel = upgrade.level + 1;
      const newCost = Math.ceil(upgrade.baseCost * Math.pow(upgrade.costIncrease, newLevel));

      return {
        ...prev,
        currencies: { 
            ...prev.currencies, 
            [upgrade.currency]: prev.currencies[upgrade.currency] - cost,
        },
        upgrades: { ...prev.upgrades, [upgradeId]: { ...upgrade, level: newLevel, cost: newCost } },
      };
    });
  }, []);

  const handlePrestige = useCallback(() => {
    if (gameState.currencies[Currency.PrimaMateria] < prestigeCost || distillationPhase !== 'idle') return;
    setDistillationPhase('confirming');
  }, [gameState.currencies, prestigeCost, distillationPhase]);
  
  const executePrestige = useCallback(() => {
    setDistillationPhase('ui-dissolve');

    setTimeout(() => setDistillationPhase('collapsing'), 800);

    setTimeout(() => {
      setDistillationPhase('exploding');
      const alkahestGained = 1 + gameStateRef.current.stats.distillationCount;
      setDistillationSummary({ alkahestGained });

      setGameState(prev => {
          const prestigeUpgrades = { ...prev.upgrades };
          
          Object.keys(INITIAL_UPGRADES).forEach(key => {
              const initialU = INITIAL_UPGRADES[key];
              if (initialU.currency === Currency.Alkahest) return;
              if (initialU.currency === Currency.PrimaMateria && prev.upgrades.unlockMateriaUpgrades.level > 0) return;
              if (initialU.currency === Currency.PhilosophersDew && prev.upgrades.unlockDewUpgrades.level > 0) return;

              prestigeUpgrades[key] = { ...INITIAL_UPGRADES[key] };
          });
          
          const startingMateria = prev.upgrades.primordialSoup.effect(prev.upgrades.primordialSoup.level, prev);
          const startingDew = prev.upgrades.celestialDew.effect(prev.upgrades.celestialDew.level, prev);

          return {
              ...prev,
              currencies: {
                  [Currency.PrimaMateria]: startingMateria,
                  [Currency.PhilosophersDew]: startingDew,
                  [Currency.Alkahest]: prev.currencies[Currency.Alkahest] + alkahestGained,
              },
              upgrades: prestigeUpgrades,
              totalPrimaMateriaEver: startingMateria,
              totalPhilosophersDewEver: startingDew,
              totalAlkahestEver: (prev.totalAlkahestEver || 0) + alkahestGained,
              stats: { 
                  ...prev.stats, 
                  distillationCount: prev.stats.distillationCount + 1,
                  totalClicks: 0,
                  essencesClicked: 0,
                  golemsMined: 0,
              },
              lastTick: Date.now(),
          };
      });
      setFloatingEssences([]);
      setGolems([]);
      setHomunculi([]);
      setPrimaMateriaHistory([]);
      setPhilosophersDewHistory([]);
    }, 1800);

    setTimeout(() => setDistillationPhase('reforming'), 4000);
    setTimeout(() => setDistillationPhase('summary'), 5000);

  }, []);

  const closePrestigeSummary = useCallback(() => {
    setDistillationPhase('idle');
    setDistillationSummary(null);
  }, []);

  const handleResetSave = useCallback(() => {
    if (window.confirm("Are you sure you want to reset your progress? This action is irreversible.")) {
        localStorage.removeItem(SAVE_KEY);
        setGameState(getInitialState());
        setFloatingNumbers([]);
        setFloatingEssences([]);
        setGolems([]);
        setHomunculi([]);
        setPrimaMateriaPerSecond(0);
        setPhilosophersDewPerSecond(0);
        setPrimaMateriaHistory([]);
        setPhilosophersDewHistory([]);
        lastHistoryUpdate.current = Date.now();
    }
  }, []);
  
  const triggerCollectionEffect = (item) => {
    const newEffect = { id: Date.now() + Math.random(), x: item.x, y: item.y };
    setCollectionEffects(current => [...current, newEffect]);
    setTimeout(() => {
        setCollectionEffects(current => current.filter(e => e.id !== newEffect.id));
    }, 500); // Animation duration
  };

  const gameTick = useCallback(() => {
    const now = Date.now();
    let timeDelta = (now - gameStateRef.current.lastTick) / 1000;
    
    const currentState = gameStateRef.current;
    
    const aevumWarpBoost = currentState.upgrades.aevumWarp.effect(currentState.upgrades.aevumWarp.level, currentState);
    if (timeDelta > 5) { 
        timeDelta *= aevumWarpBoost;
    }
    timeDelta = Math.min(timeDelta, 86400);
    timeDelta = Math.max(0, timeDelta);

    const rates = calculateRates(currentState);
    setPrimaMateriaPerSecond(rates.pmps);
    setPhilosophersDewPerSecond(rates.pdps);

    let materiaFromCollection = 0;
    let newGolems = [...golems];
    let newEssences = [...floatingEssences];

    const homunculusSpeed = 20;
    const moveDist = homunculusSpeed * timeDelta;
    const collectedGolemIds = new Set();
    
    const nextHomunculi = homunculi.map(homunculus => {
        const target = newGolems.find(a => a.id === homunculus.targetId);
        if (!target) return null;

        const dx = target.x - homunculus.x;
        const dy = target.y - homunculus.y;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist <= moveDist) {
            const damageMultiplier = target.maxHealth / target.health;
            materiaFromCollection += target.value * damageMultiplier;
            collectedGolemIds.add(target.id);
            triggerCollectionEffect(target);
            return null;
        } else if (dist > 0) {
            return {
                ...homunculus,
                x: homunculus.x + (dx / dist) * moveDist,
                y: homunculus.y + (dy / dist) * moveDist,
            };
        }
        return homunculus;
    }).filter(Boolean);


    if (collectedGolemIds.size > 0) {
        newGolems = newGolems.filter(a => !collectedGolemIds.has(a.id));
    }
    const numGolemsCollected = collectedGolemIds.size;
    
    const essenceHomunculiLevel = currentState.upgrades.essenceHomunculi.level;
    let numEssencesCollected = 0;
    if (essenceHomunculiLevel >= 3 && newEssences.length > 0) {
        const valueFromEssences = newEssences.reduce((sum, o) => sum + o.value, 0);
        materiaFromCollection += valueFromEssences;
        newEssences.forEach(triggerCollectionEffect);
        numEssencesCollected = newEssences.length;
        newEssences = [];
    }
    
    // Laser damage to golems
    if (currentState.upgrades.focusingLens.level > 0 && newGolems.length > 0) {
        const laserDamage = currentState.upgrades.focusingLens.effect(currentState.upgrades.focusingLens.level, currentState) * timeDelta;
        const critChance = currentState.upgrades.laserCritChance.effect(currentState.upgrades.laserCritChance.level, currentState);
        
        newGolems.forEach(golem => {
            let damage = laserDamage;
            if (Math.random() < critChance) damage *= 10;
            golem.health = Math.max(1, golem.health - damage);
        });

        // Visual lasers
        if (Math.random() < 0.5) { // Fire lasers intermittently for performance
             const golemToShoot = newGolems[Math.floor(Math.random() * newGolems.length)];
             const angle = Math.random() * 2 * Math.PI;
             const newLaser = {
                id: Date.now() + Math.random(),
                from: { x: 50 + Math.cos(angle) * 30, y: 50 + Math.sin(angle) * 30 },
                to: { x: golemToShoot.x, y: golemToShoot.y }
             };
             setLasers(current => [...current, newLaser]);
             setTimeout(() => setLasers(current => current.filter(l => l.id !== newLaser.id)), 200);
        }
    }


    const collector = currentState.upgrades.essenceCollector;
    if (collector.level > 0 && newEssences.length < 10) {
        if (Math.random() < collector.effect(collector.level, currentState) * timeDelta) {
            const angle = Math.random() * 2 * Math.PI;
            newEssences.push({
                id: Date.now() + Math.random(),
                value: (rates.pmps + getClickValue(currentState)) * (5 + collector.level * 0.5) * currentState.upgrades.aethericWells.effect(currentState.upgrades.aethericWells.level, currentState),
                x: 50 + Math.cos(angle) * (40 + Math.random() * 5),
                y: 50 + Math.sin(angle) * (40 + Math.random() * 5),
            });
        }
    }

    const prospector = currentState.upgrades.golemProspecting;
    if (prospector.level > 0 && newGolems.length < 5) {
        if (Math.random() < prospector.effect(prospector.level, currentState) * timeDelta) {
            const angle = Math.random() * 2 * Math.PI;
            const baseValue = (rates.pmps + getClickValue(currentState)) * (10 + prospector.level);
            const isGolden = Math.random() < currentState.upgrades.goldenTransmutation.effect(currentState.upgrades.goldenTransmutation.level, currentState);
            const value = isGolden ? baseValue * 100 : baseValue;
            const maxHealth = 100 + prospector.level * 10;

            const newGolem = {
                id: Date.now() + Math.random(),
                value: value,
                x: 50 + Math.cos(angle) * (45 + Math.random() * 5),
                y: 50 + Math.sin(angle) * (45 + Math.random() * 5),
                maxHealth: maxHealth,
                health: maxHealth,
                isGolden: isGolden
            };
            newGolems.push(newGolem);
            if (currentState.upgrades.homunculusService.level >= 3 && !nextHomunculi.find(d => d.targetId === newGolem.id)) {
                nextHomunculi.push({ id: Date.now() + Math.random(), targetId: newGolem.id, x: 50, y: 50 });
            }
        }
    }
    
    setGolems(newGolems);
    setFloatingEssences(newEssences);
    setHomunculi(nextHomunculi);

    setGameState(prev => {
        const materiaFromPassive = rates.pmps * timeDelta;
        const dewFromPassive = rates.pdps * timeDelta;
        
        const newPrimaMateria = prev.currencies[Currency.PrimaMateria] + materiaFromPassive + materiaFromCollection;
        const newPhilosophersDew = prev.currencies[Currency.PhilosophersDew] + dewFromPassive;
        
        if (now - lastHistoryUpdate.current >= 1000) {
            lastHistoryUpdate.current = now;
            setPrimaMateriaHistory(prevHistory => [...prevHistory, { timestamp: now, total: newPrimaMateria }].slice(-60));
            setPhilosophersDewHistory(prevHistory => [...prevHistory, { timestamp: now, total: newPhilosophersDew }].slice(-60));
        }
        
        return {
            ...prev,
            currencies: {
                ...prev.currencies,
                [Currency.PrimaMateria]: newPrimaMateria,
                [Currency.PhilosophersDew]: newPhilosophersDew,
            },
            totalPrimaMateriaEver: prev.totalPrimaMateriaEver + materiaFromPassive + materiaFromCollection,
            totalPhilosophersDewEver: prev.totalPhilosophersDewEver + dewFromPassive,
            stats: { 
                ...prev.stats, 
                playTime: prev.stats.playTime + timeDelta,
                golemsMined: (prev.stats.golemsMined || 0) + numGolemsCollected,
                essencesClicked: (prev.stats.essencesClicked || 0) + numEssencesCollected,
            },
            lastTick: now,
        };
    });
}, [getClickValue, golems, floatingEssences, homunculi, calculateRates]);

  useGameLoop(gameTick, 100);

  const alchemicalPower = useMemo(() => Object.values(gameState.upgrades)
    .filter((u) => u.currency === Currency.PrimaMateria)
    .reduce((sum, u) => sum + (u.level || 0), 0), [gameState.upgrades]);

  const detailedStats = useMemo(() => {
      const playTime = gameState.stats.playTime;
      const hours = Math.floor(playTime / 3600);
      const minutes = Math.floor((playTime % 3600) / 60);
      const seconds = Math.floor(playTime % 60);
      const formattedPlayTime = `${hours}h ${minutes}m ${seconds}s`;
      const distillationBonusRaw = 0.25 + gameState.upgrades.quintessence.effect(gameState.upgrades.quintessence.level, gameState);

      return {
          primaMateriaPerSecond: primaMateriaPerSecond,
          philosophersDewPerSecond: philosophersDewPerSecond,
          primaMateriaPerClick: getClickValue(gameStateRef.current),
          totalClicks: gameState.stats.totalClicks,
          distillationCount: gameState.stats.distillationCount,
          playTime: formattedPlayTime,
          distillationBonus: `${(gameState.stats.distillationCount * distillationBonusRaw * 100).toFixed(0)}%`,
          totalPrimaMateriaEver: formatNumber(gameState.totalPrimaMateriaEver),
          totalPhilosophersDewEver: formatNumber(gameState.totalPhilosophersDewEver),
          essencesClicked: formatNumber(gameState.stats.essencesClicked || 0),
          golemsMined: formatNumber(gameState.stats.golemsMined || 0),
      }
  }, [primaMateriaPerSecond, philosophersDewPerSecond, getClickValue, gameState]);

  if (isLoading) {
    return <LoadingScreen onLoaded={() => setIsLoading(false)} />;
  }

  return (
    <div className="app-container">
      <style>{`
        .app-container {
          height: 100%;
          display: flex;
          flex-direction: column;
          background: radial-gradient(ellipse at bottom, var(--stone-800) 0%, var(--stone-950) 100%);
        }
        .distillation-phase-wrapper {
          flex: 1;
          display: flex;
          flex-direction: column;
          min-height: 0;
        }
        .app-main-layout {
          flex-grow: 1;
          display: flex;
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
          overflow-y: auto;
        }
        .main-game-container {
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
        }
        .upgrades-container, .header-wrapper {
            transition: transform 0.8s ease-in-out, opacity 0.8s ease-in-out;
        }

        [data-distillation-phase="ui-dissolve"] .app-container {
            animation: shake-subtle 0.5s;
        }
        [data-distillation-phase="ui-dissolve"] .header-wrapper,
        [data-distillation-phase="ui-dissolve"] .upgrades-container {
            animation: ui-dissolve-out 0.8s ease-in forwards;
        }
        [data-distillation-phase="reforming"] .header-wrapper,
        [data-distillation-phase="reforming"] .upgrades-container {
            animation: ui-reform-in 1s 0.2s ease-out forwards;
        }

        .distillation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle, var(--stone-900) 0%, var(--stone-950) 100%);
            z-index: 9999;
            pointer-events: none;
            animation: distillation-fade-in-out 4s ease-in-out forwards;
        }
        .distillation-flash {
            position: absolute; width: 100vw; height: 100vh;
            background: white; border-radius: 50%;
            transform: scale(0); opacity: 1;
            animation: distillation-flash-anim 1.5s 0.2s ease-out forwards;
        }
        .distillation-wave-1 {
            position: absolute; width: 1vmin; height: 1vmin;
            border-radius: 50%;
            border: 3px solid var(--amber-300);
            animation: distillation-wave 1.5s 0.3s ease-out forwards;
        }
        .distillation-wave-2 {
            position: absolute; width: 1vmin; height: 1vmin;
            border-radius: 50%;
            border: 4px solid var(--violet-300);
            animation: distillation-wave 1.5s 0.5s ease-out forwards;
        }

        @media (min-width: 1024px) {
          .app-main-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            height: 100%;
            overflow: hidden; /* Prevent parent from scrolling */
          }
          .upgrades-container {
            min-height: 0; /* Fix for scrollbar on grid item child */
          }
        }
      `}</style>
      {offlineReport && <OfflineReportModal report={offlineReport} onClose={() => setOfflineReport(null)} />}
      {distillationPhase === 'confirming' && (
        <DistillationConfirmationModal 
            onConfirm={executePrestige} 
            onCancel={() => setDistillationPhase('idle')}
            cost={prestigeCost}
            gain={alkahestToGain}
        />
      )}
      {distillationPhase === 'summary' && distillationSummary && (
        <DistillationSummaryModal
            alkahestGained={distillationSummary.alkahestGained}
            onClose={closePrestigeSummary}
        />
      )}
      {distillationPhase === 'exploding' && (
        <div className="distillation-overlay">
            <div className="distillation-flash" />
            <div className="distillation-wave-1" />
            <div className="distillation-wave-2" />
        </div>
      )}
      <div data-distillation-phase={distillationPhase} className="distillation-phase-wrapper" style={{pointerEvents: distillationPhase !== 'idle' ? 'none' : 'auto'}}>
          <div className="header-wrapper" style={{padding: '1rem 1rem 0 1rem', flexShrink: 0}}>
            <Header currencies={gameState.currencies} />
          </div>
          <main className="app-main-layout">
            <div className="main-game-container">
                <MainGameArea 
                  onClick={handleFlaskClick} 
                  floatingNumbers={floatingNumbers}
                  alchemicalPower={alchemicalPower}
                  floatingEssences={floatingEssences}
                  onEssenceClick={handleEssenceClick}
                  golems={golems}
                  onGolemClick={handleGolemClick}
                  collectionEffects={collectionEffects}
                  homunculi={homunculi}
                  distillationPhase={distillationPhase}
                  lasers={lasers}
                />
            </div>
            <div className="upgrades-container">
                <UpgradesPanel 
                  upgrades={gameState.upgrades} 
                  onPurchase={handlePurchaseUpgrade} 
                  currencies={gameState.currencies}
                  onPrestige={handlePrestige}
                  canPrestige={gameState.currencies[Currency.PrimaMateria] >= prestigeCost}
                  prestigeCost={prestigeCost}
                  primaMateriaHistory={primaMateriaHistory}
                  philosophersDewHistory={philosophersDewHistory}
                  detailedStats={detailedStats}
                  onResetSave={handleResetSave}
                />
            </div>
          </main>
      </div>
    </div>
  );
};

// === FROM index.tsx ===
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <StrictMode>
    <App />
  </StrictMode>
);

    </script>
  </body>
</html>